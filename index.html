<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>three.js - pointerlock controls</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>

<div id="blocker">

    <div id="hurt" style="display: none"></div>
    <div id="instructions">
        <span style="font-size:40px">Click to play</span>
        <br />
        (W, A, S, D = Move, SPACE = Jump, MOUSE = Look around)
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r73/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/1.1.29/howler.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.0.0/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script src="OBJLoader.js"></script>
<script src="MTLLoader.js"></script>
<script src="OBJMTLLoader.js"></script>
<script src="PointerLockControls.js"></script>

<script>

var camera, scene, renderer;
var controls;

var objects = [];
var ghosts = [];
var ghostsHealth = [];
var t = THREE;
var tried;

var raycaster;
var lastPos;
var target;

var blocker = document.getElementById('blocker');
var instructions = document.getElementById('instructions');

var lastHurt = Date.now();

//Controls
var controlsEnabled = false;

var moveForward = false;
var moveBackward = false;
var moveLeft = false;
var moveRight = false;
var canJump = false;

var Sounds;

//Animation
var prevTime = performance.now();
var velocity = new THREE.Vector3();

</script>

<script src="sounds.js"></script>
<script src="start.js"></script>
<script src="setup.js"></script>

<script>

setup();

function animate() {

    requestAnimationFrame(animate);

    if (controlsEnabled && loaded) {
        raycaster.ray.origin.copy(controls.getObject().position);
        raycaster.ray.origin.y -= 10;

        var intersections = raycaster.intersectObjects(objects);

        var isOnObject = intersections.length > 0;

        var time = performance.now();
        var delta = (time - prevTime) / 1000;

        velocity.x -= velocity.x * 10.0 * delta;
        velocity.z -= velocity.z * 10.0 * delta;

        velocity.y -= 9.8 * 100.0 * delta; // 100.0 = mass

        if (moveForward) velocity.z -= 400.0 * delta;
        if (moveBackward) velocity.z += 400.0 * delta;

        if (moveLeft) velocity.x -= 400.0 * delta;
        if (moveRight) velocity.x += 400.0 * delta;

        if (moveLeft || moveRight || moveForward || moveBackward) {
          Sounds.playFootstep();
        }

        if (isOnObject === true) {
            velocity.y = Math.max(0, velocity.y);

            canJump = true;
        }

        controls.getObject().translateX(velocity.x * delta);
        controls.getObject().translateY(velocity.y * delta);
        controls.getObject().translateZ(velocity.z * delta);


        if (controls.getObject().position.y < 10) {

            velocity.y = 0;
            controls.getObject().position.y = 10;

            canJump = true;

        }


        moveGhosts();
        checkLightCollision();
        prevTime = time;

        renderer.render(scene, camera);
    }

}

function moveGhosts() {
    var pos = controls.getObject().position;

    ghosts.map(function(ghost, i) {
        var x = ghost.position.x;
        var y = ghost.position.z;
        var xVal;
        var yVal;

        if (pos.x > x) {
            xVal = (1 / 4);
        } else {
            xVal = -(1 / 4)
        }

        if (pos.z > y) {
            yVal = (1 / 4);
        } else {
            yVal = - (1 / 4);
        }

        ghost.position.x = xVal + x;
        ghost.position.z = yVal + y;

        if (Date.now() % 10 === 0) {
            ghost.lookAt(pos);
        }
        var now = Date.now();

        if (lastHurt + 500 < now) {
            lastHurt = now;
            if (ghost.position.distanceTo(pos) < 40) {
                $('#hurt').fadeIn(75);
                $('#hurt').fadeOut(375);

                Sounds.playHurtSound();
            }
        }
    });
}

function checkLightCollision() {
    if (!tried) {

    tried = true;
        return false;
    }
    var cont = controls.getObject();
    var dir = camera.getWorldDirection();
    var pos = cont.position;
    var ray = new THREE.Raycaster(pos, dir, pos, 80);

    var intersects = ray.intersectObjects(ghosts);

    if (intersects.length > 0) {

        intersects.map(function(intersect, i) {
            var ghost = intersect.object;
            var gho = ghost.position;
            var fromGhost = gho.distanceTo(pos);
            var tooClose = fromGhost < 10;

            if (!tooClose) {
                var health = ghostsHealth[ghost.userData.index];
                var now = Date.now();

                if (!health) {
                    health = {value: 11, lastChanged: now};
                    removeHealth(ghost, health);
                } else if (health.lastChanged + 500 < now) {
                    removeHealth(ghost, health)
                }

            }
        });
    }


}

function removeHealth(ghost, health) {
    var index = ghost.userData.index;
    var color = ghost.material.color;
    var percent;
    ghost = ghosts[index];

    health.value -= 1;
    health.lastChanged = Date.now();

    percent = health.value / 10;

    ghostsHealth[index] = health;

    ghost.material.color.setRGB(
        percent * color.r,
        percent * color.g,
        percent * color.b
   );

    if (health.value <= 0) {
        killGhost(ghost, index);
    }
}

function killGhost(ghost) {
    scene.remove(ghost);
}

</script>
</body>
</html>
